# æ¯æ—¥ä»»åŠ¡é‡ç½®é€»è¾‘åˆ†ææŠ¥å‘Š

## ğŸ“… é‡ç½®è§„åˆ™æ€»ç»“

### âœ… å½“å‰å®ç°é€»è¾‘

**é‡ç½®æ—¶é—´**: æ¯å¤© **00:00:00**ï¼ˆæœ¬åœ°æ—¶åŒºï¼‰  
**é‡ç½®æ–¹å¼**: **è¢«åŠ¨é‡ç½®**ï¼ˆä¸‹æ¬¡è®¿é—®æ—¶æ£€æŸ¥æ—¥æœŸï¼‰  
**æ—¶åŒºä¾èµ–**: ä½¿ç”¨è®¾å¤‡æœ¬åœ°æ—¶åŒº  

å¯¹äº **UTC+8ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰** çš„è®¾å¤‡ï¼š
- ğŸ• é‡ç½®æ—¶é—´ç‚¹ï¼š**æ¯å¤© 00:00:00 åŒ—äº¬æ—¶é—´**
- ğŸ“ åˆ¤æ–­ä¾æ®ï¼š`SimpleDateFormat("yyyy-MM-dd", Locale.US)` æ ¼å¼åŒ–çš„æ—¥æœŸå­—ç¬¦ä¸²

---

## ğŸ” ä»£ç å®ç°è¯¦è§£

### 1ï¸âƒ£ æ—¥æœŸè·å–æ–¹å¼

**QuranReadingTracker.java & QuranListeningTracker.java:**
```java
private String getTodayDateString() {
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd", Locale.US);
    return sdf.format(new Date());
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `SimpleDateFormat` æ ¼å¼åŒ– `new Date()`
- âœ… é»˜è®¤ä½¿ç”¨**ç³»ç»Ÿæœ¬åœ°æ—¶åŒº**ï¼ˆAsia/Shanghai = UTC+8ï¼‰
- âœ… è¿”å›æ ¼å¼ï¼š`"2025-10-22"`

**QuestRepository.kt:**
```kotlin
val date: LocalDate = LocalDate.now()
val dateId = date.toString() // "2025-10-22"
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `LocalDate.now()` è·å–æœ¬åœ°æ—¥æœŸ
- âœ… é»˜è®¤ä½¿ç”¨**ç³»ç»Ÿé»˜è®¤æ—¶åŒº**
- âœ… ä¸ `SimpleDateFormat` ç»“æœä¸€è‡´

---

### 2ï¸âƒ£ é‡ç½®è§¦å‘é€»è¾‘

**ä½ç½®**: `QuranReadingTracker.getTodayPagesRead()` / `QuranListeningTracker.getTodaySecondsListened()`

```java
public int getTodayPagesRead() {
    String today = getTodayDateString();              // "2025-10-22"
    String savedDate = prefs.getString(KEY_LAST_DATE, ""); // "2025-10-21"
    
    // å¦‚æœæ—¥æœŸä¸åŒ¹é… â†’ é‡ç½®
    if (!today.equals(savedDate)) {
        resetDailyProgress();
        return 0;
    }
    
    return prefs.getInt(KEY_PAGES_READ_TODAY, 0);
}
```

**é‡ç½®æ¡ä»¶**: `today != savedDate`

**é‡ç½®åŠ¨ä½œ**:
```java
private void resetDailyProgress() {
    String today = getTodayDateString();
    prefs.edit()
        .putInt(KEY_PAGES_READ_TODAY, 0)           // âœ… æ¸…é›¶è¿›åº¦
        .putString(KEY_LAST_DATE, today)            // âœ… æ›´æ–°æ—¥æœŸ
        .putBoolean(KEY_TASK_COMPLETED_TODAY, false) // âœ… é‡ç½®å®ŒæˆçŠ¶æ€
        .apply();
}
```

---

### 3ï¸âƒ£ é‡ç½®æ—¶æœºï¼ˆè¢«åŠ¨è§¦å‘ï¼‰

**å…³é”®ç‚¹**: ä¸æ˜¯ä¸»åŠ¨å®šæ—¶é‡ç½®ï¼Œè€Œæ˜¯**è¢«åŠ¨æ£€æŸ¥**

**è§¦å‘æ—¶æœº**:
1. ç”¨æˆ·æ‰“å¼€åº”ç”¨è¿›å…¥ä¸»é¡µ
2. `DailyQuestsManager` åˆå§‹åŒ–
3. è°ƒç”¨ `getTodayPagesRead()` / `getTodaySecondsListened()`
4. **æ­¤æ—¶æ‰æ¯”è¾ƒæ—¥æœŸå¹¶å¯èƒ½é‡ç½®**

**ç¤ºä¾‹åœºæ™¯**:

| æ—¶é—´ | åŠ¨ä½œ | last_date | å½“å‰æ—¥æœŸ | æ˜¯å¦é‡ç½® |
|------|------|-----------|----------|----------|
| 10-21 23:50 | å®Œæˆä»»åŠ¡ | 2025-10-21 | 2025-10-21 | âŒ |
| 10-21 23:59 | å…³é—­åº”ç”¨ | 2025-10-21 | 2025-10-21 | âŒ |
| **(è·¨å¤©)** | - | - | - | - |
| 10-22 00:00 | *(åº”ç”¨æœªæ‰“å¼€)* | 2025-10-21 | 2025-10-22 | â³ å¾…è§¦å‘ |
| 10-22 08:00 | **æ‰“å¼€åº”ç”¨** | 2025-10-21 | 2025-10-22 | âœ… **é‡ç½®** |

---

## ğŸ“Š å½“å‰è®¾å¤‡çŠ¶æ€åˆ†æ

### è®¾å¤‡ä¿¡æ¯
```
æ—¶åŒº: Asia/Shanghai (UTC+8)
å½“å‰æ—¶é—´: 2025-10-22 12:11:34 CST
é‡ç½®æ—¶é—´ç‚¹: æ¯å¤© 00:00:00 åŒ—äº¬æ—¶é—´
```

### SharedPreferences å®é™…æ•°æ®

**é˜…è¯»ä»»åŠ¡**:
```xml
<int name="pages_read_today" value="7" />
<string name="last_date">2025-10-22</string>
<boolean name="task_completed_today" value="true" />
<string name="completed_date">2025-10-22</string>
```

**å¬åŠ›ä»»åŠ¡**:
```xml
<int name="seconds_listened_today" value="904" />
<int name="minutes_listened_today" value="15" />
<string name="last_date">2025-10-22</string>
<boolean name="task_completed_today" value="true" />
<string name="completed_date">2025-10-22</string>
```

### çŠ¶æ€åˆ¤æ–­

| é¡¹ç›® | å€¼ | åˆ†æ |
|------|-----|------|
| å­˜å‚¨æ—¥æœŸ | `2025-10-22` | âœ… |
| å½“å‰æ—¥æœŸ | `2025-10-22` | âœ… |
| æ—¥æœŸåŒ¹é… | **YES** | âœ… ä»Šå¤©çš„ä»»åŠ¡è®°å½• |
| æ˜¾ç¤ºå®ŒæˆçŠ¶æ€ | **æ­£ç¡®** | âœ… ä»Šå¤©å·²å®Œæˆ |

**ç»“è®º**: 
- âœ… **ä»»åŠ¡çŠ¶æ€æ­£ç¡®**
- ğŸ“… è®°å½•æ—¥æœŸæ˜¯ `2025-10-22`ï¼ˆä»Šå¤©ï¼‰
- ğŸ• ä¸‹æ¬¡é‡ç½®æ—¶é—´: **æ˜å¤© 00:00:00 åŒ—äº¬æ—¶é—´**

---

## â“ ç”¨æˆ·æŠ¥å‘Šåœºæ™¯åˆ†æ

### ç”¨æˆ·æè¿°
> "æ˜¨æ™š23ç‚¹å·¦å³è¿›è¡Œäº†3ä¸ªä»»åŠ¡æµ‹è¯•å¹¶éƒ½æ˜¯å®ŒæˆçŠ¶æ€ï¼ŒStreak +1ã€‚ç›®å‰è¿˜æ˜¯å®ŒæˆçŠ¶æ€"

### å¯èƒ½æƒ…å†µåˆ†æ

#### æƒ…å†µA: å®Œæˆæ—¶é—´åœ¨ 10-22 00:00 ä¹‹å âœ…
```
10-21 23:00 â†’ 10-22 00:30 ä¹‹é—´çš„æŸä¸ªæ—¶é—´å®Œæˆä»»åŠ¡
è®°å½•æ—¥æœŸ: 2025-10-22
å½“å‰æ—¥æœŸ: 2025-10-22
çŠ¶æ€: æ˜¾ç¤ºå®Œæˆ â†’ âœ… æ­£ç¡®
```

#### æƒ…å†µB: å®Œæˆæ—¶é—´åœ¨ 10-21 23:xx âŒ
```
10-21 23:xx å®Œæˆä»»åŠ¡
è®°å½•æ—¥æœŸåº”è¯¥æ˜¯: 2025-10-21
ä½†å®é™…è®°å½•æ˜¯: 2025-10-22 â† æœ‰é—®é¢˜
```

### éªŒè¯æ–¹æ³•

**è¯·ç”¨æˆ·ç¡®è®¤**:
1. â“ æ˜¨æ™šå®Œæˆä»»åŠ¡çš„ç¡®åˆ‡æ—¶é—´ï¼Ÿ
   - æ˜¯ **10-21 23:xx**ï¼ˆ10æœˆ21æ—¥æ™šä¸Š11ç‚¹ï¼‰ï¼Ÿ
   - è¿˜æ˜¯ **10-22 00:xx**ï¼ˆ10æœˆ22æ—¥å‡Œæ™¨0ç‚¹åï¼‰ï¼Ÿ

2. â“ å®Œæˆä»»åŠ¡åæ˜¯å¦é‡å¯è¿‡åº”ç”¨ï¼Ÿ
   - å¦‚æœåœ¨ 10-21 23:xx å®Œæˆï¼Œç„¶å 10-22 00:xx åé‡å¯ï¼Œæ—¥æœŸä¼šæ›´æ–°ä¸º 10-22

3. â“ ä¸»é¡µä»»åŠ¡å¡å½“å‰æ˜¾ç¤ºçŠ¶æ€ï¼Ÿ
   - æ˜¯å¦æ˜¾ç¤º âœ“ï¼ˆå®Œæˆæ ‡è®°ï¼‰ï¼Ÿ
   - Streak æ•°å­—æ˜¯å¤šå°‘ï¼Ÿ

---

## ğŸ§ª æµ‹è¯•é‡ç½®é€»è¾‘

### æµ‹è¯•æ­¥éª¤

æˆ‘å¯ä»¥ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ¥éªŒè¯é‡ç½®é€»è¾‘æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
# 1. æ‰‹åŠ¨è®¾ç½® last_date ä¸ºæ˜¨å¤©
adb shell "run-as com.quran.quranaudio.online ..."

# 2. é‡å¯åº”ç”¨
adb shell am force-stop com.quran.quranaudio.online
adb shell am start -n com.quran.quranaudio.online/.SplashScreenActivity

# 3. æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨é‡ç½®
adb shell "run-as com.quran.quranaudio.online cat .../QuranReadingQuestPrefs.xml"
```

**é¢„æœŸç»“æœ**:
- `last_date` åº”æ›´æ–°ä¸ºä»Šå¤©
- `task_completed_today` åº”é‡ç½®ä¸º `false`
- `pages_read_today` åº”é‡ç½®ä¸º `0`

---

## ğŸ”§ æ½œåœ¨é—®é¢˜å’Œå»ºè®®

### å½“å‰å®ç°çš„é—®é¢˜

#### 1ï¸âƒ£ è¢«åŠ¨é‡ç½®å¯èƒ½å¯¼è‡´çš„é—®é¢˜

**åœºæ™¯**: ç”¨æˆ·åœ¨è·¨å¤©æ—¶åˆ»ä¸æ‰“å¼€åº”ç”¨
```
10-21 å®Œæˆä»»åŠ¡ â†’ ä¸æ‰“å¼€åº”ç”¨ â†’ 10-23 æ‰“å¼€åº”ç”¨
```

**å½“å‰è¡Œä¸º**:
- âœ… 10-23 æ‰“å¼€æ—¶ä¼šé‡ç½®
- âš ï¸ ä½† 10-22 çš„è®°å½•ä¸¢å¤±ï¼ˆæ²¡æœ‰åˆ›å»º 10-22 çš„ Firebase æ–‡æ¡£ï¼‰
- âš ï¸ Streak æ£€æµ‹å¯èƒ½è¯¯åˆ¤ä¸º"è·³è¿‡ä¸€å¤©"

#### 2ï¸âƒ£ æ—¶åŒºåˆ‡æ¢é—®é¢˜

**åœºæ™¯**: ç”¨æˆ·è·¨æ—¶åŒºæ—…è¡Œ

```
åŒ—äº¬æ—¶é—´ 10-21 23:00 å®Œæˆä»»åŠ¡ (UTC+8)
â†’ é£åˆ°ä¼¦æ•¦ (UTC+0)
â†’ ä¼¦æ•¦æ—¶é—´ 10-21 16:00 æ‰“å¼€åº”ç”¨
```

**å½“å‰è¡Œä¸º**:
- âš ï¸ ç³»ç»Ÿè®¤ä¸ºè¿˜æ˜¯ 10-21ï¼Œä¸ä¼šé‡ç½®
- âš ï¸ ä½†å®é™…ä¸ŠåŒ—äº¬å·²ç»åˆ° 10-22

#### 3ï¸âƒ£ Firebase æ–‡æ¡£æ—¥æœŸä¸æœ¬åœ°ä¸ä¸€è‡´

**å¯èƒ½æƒ…å†µ**:
- æœ¬åœ° SharedPreferences ä½¿ç”¨ `SimpleDateFormat`ï¼ˆç³»ç»Ÿæ—¶åŒºï¼‰
- Firebase ä½¿ç”¨ `LocalDate.now()`ï¼ˆç³»ç»Ÿæ—¶åŒºï¼‰
- å¦‚æœç”¨æˆ·åœ¨è·¨æ—¶åŒºæ—¶å®Œæˆä»»åŠ¡ï¼Œå¯èƒ½ä¸ä¸€è‡´

---

## âœ… å½“å‰å®ç°çš„æ­£ç¡®æ€§

### å¯¹äºå›ºå®šæ—¶åŒºç”¨æˆ·ï¼ˆå¤§å¤šæ•°æƒ…å†µï¼‰

**ç»“è®º**: âœ… **å®ç°æ­£ç¡®**

**ç†ç”±**:
1. âœ… ä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼Œç¬¦åˆç”¨æˆ·ç›´è§‰
2. âœ… é‡ç½®æ—¶é—´ä¸ºæ¯å¤© 00:00:00 æœ¬åœ°æ—¶é—´
3. âœ… SharedPreferences å’Œ Firebase ä½¿ç”¨ç›¸åŒçš„æ—¥æœŸé€»è¾‘
4. âœ… è¢«åŠ¨é‡ç½®è™½ç„¶ä¸æ˜¯æœ€ä¼˜ï¼Œä½†è¶³å¤Ÿå¯é 

### å¯¹äºæ‚¨çš„è®¾å¤‡ï¼ˆUTC+8 åŒ—äº¬ï¼‰

**é‡ç½®æ—¶é—´**: **æ¯å¤© 00:00:00 åŒ—äº¬æ—¶é—´**

**æ—¶é—´è½´**:
```
10-21 23:59:59 CST â†’ ä»»åŠ¡çŠ¶æ€ä¿ç•™ï¼ˆ10-21çš„è®°å½•ï¼‰
10-22 00:00:00 CST â†’ æ—¥æœŸåˆ‡æ¢ï¼ˆä½†åº”ç”¨æœªæ‰“å¼€ï¼Œæœªé‡ç½®ï¼‰
10-22 08:00:00 CST â†’ æ‰“å¼€åº”ç”¨ â†’ æ£€æµ‹åˆ°æ—¥æœŸå˜åŒ– â†’ è‡ªåŠ¨é‡ç½®
```

**å½“å‰çŠ¶æ€**:
- âœ… `last_date = 2025-10-22`
- âœ… `current_date = 2025-10-22`
- âœ… æ˜¾ç¤ºå®ŒæˆçŠ¶æ€æ˜¯æ­£ç¡®çš„ï¼ˆå› ä¸ºæ˜¯ä»Šå¤©å®Œæˆçš„ï¼‰

---

## ğŸ¯ ç»“è®ºå’Œå»ºè®®

### ç»“è®º

1. **é‡ç½®è§„åˆ™æ­£ç¡®**: âœ… æ¯å¤© 00:00:00 æœ¬åœ°æ—¶åŒºé‡ç½®
2. **å½“å‰çŠ¶æ€æ­£ç¡®**: âœ… æ‚¨çš„è®¾å¤‡æ˜¾ç¤ºä»Šå¤©çš„å®ŒæˆçŠ¶æ€
3. **ç”¨æˆ·è®°å¿†å¯èƒ½æœ‰è¯¯**: 
   - å¯èƒ½åœ¨ 10-22 å‡Œæ™¨ 00:xx ä¹‹åæ‰å®Œæˆä»»åŠ¡
   - æˆ–è€…åœ¨ 10-22 æ—©ä¸Šé‡å¯åº”ç”¨åæ‰è®°å½•ä¸º 10-22

### å»ºè®®

#### ç«‹å³éªŒè¯æ–¹æ¡ˆ

**è¯·ç”¨æˆ·ç¡®è®¤ä»¥ä¸‹ä¿¡æ¯**:
1. æ˜¨æ™šå®Œæˆä»»åŠ¡çš„å‡†ç¡®æ—¶é—´ï¼ˆæ˜¯ 21å·æ™šä¸Šè¿˜æ˜¯ 22å·å‡Œæ™¨ï¼‰
2. å®Œæˆä»»åŠ¡åæ˜¯å¦é‡å¯è¿‡åº”ç”¨
3. Firebase Console ä¸­æŸ¥çœ‹ `dailyProgress` é›†åˆï¼ŒæŸ¥çœ‹æ–‡æ¡£IDå’Œæ—¶é—´æˆ³

#### å¯é€‰ä¼˜åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰

å¦‚æœç¡®è®¤æœ‰é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **æ·»åŠ è¯¦ç»†æ—¥å¿—**:
```java
Log.d(TAG, "ğŸ“… Date check: saved=" + savedDate + ", today=" + today + 
           ", time=" + System.currentTimeMillis());
```

2. **æ·»åŠ ä¸»åŠ¨é‡ç½®ï¼ˆWorkManagerï¼‰**:
```kotlin
// æ¯å¤©å‡Œæ™¨ 00:01 ä¸»åŠ¨æ£€æŸ¥å¹¶é‡ç½®
WorkManager.enqueue(
    PeriodicWorkRequest.Builder(ResetQuestWorker::class.java, 24, TimeUnit.HOURS)
        .setInitialDelay(calculateDelayUntilMidnight(), TimeUnit.MILLISECONDS)
        .build()
)
```

3. **åœ¨ UI æ˜¾ç¤ºé‡ç½®å€’è®¡æ—¶**:
```kotlin
"ä»»åŠ¡å°†åœ¨ XXå°æ—¶XXåˆ†åé‡ç½®"
```

---

## ğŸ“ æµ‹è¯•éªŒè¯è„šæœ¬

å¦‚éœ€éªŒè¯é‡ç½®é€»è¾‘ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. æŸ¥çœ‹å½“å‰çŠ¶æ€
adb shell "run-as com.quran.quranaudio.online cat /data/data/com.quran.quranaudio.online/shared_prefs/QuranReadingQuestPrefs.xml"

# 2. æ‰‹åŠ¨è®¾ç½®ä¸ºæ˜¨å¤©
YESTERDAY=$(date -v-1d '+%Y-%m-%d' 2>/dev/null || date -d 'yesterday' '+%Y-%m-%d')
# ... ä¿®æ”¹ SharedPreferences ...

# 3. é‡å¯åº”ç”¨å¹¶æ£€æŸ¥
adb shell am force-stop com.quran.quranaudio.online
adb shell am start -n com.quran.quranaudio.online/.SplashScreenActivity
sleep 5

# 4. éªŒè¯æ˜¯å¦é‡ç½®
adb shell "run-as com.quran.quranaudio.online cat /data/data/com.quran.quranaudio.online/shared_prefs/QuranReadingQuestPrefs.xml"
```

---

**ç”Ÿæˆæ—¶é—´**: 2025-10-22 12:11  
**è®¾å¤‡æ—¶åŒº**: Asia/Shanghai (UTC+8)  
**å½“å‰æ—¥æœŸ**: 2025-10-22


