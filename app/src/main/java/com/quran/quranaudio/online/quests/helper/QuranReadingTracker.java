package com.quran.quranaudio.online.quests.helper;

import android.content.Context;
import android.content.SharedPreferences;
import android.util.Log;

import com.google.firebase.auth.FirebaseAuth;
import com.google.firebase.firestore.FirebaseFirestore;
import com.quran.quranaudio.online.quests.repository.QuestRepository;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Locale;

/**
 * Helper class to track Quran reading progress for Daily Quests.
 * 
 * Since converting Surah/Ayah to precise page numbers requires a Mushaf mapping table,
 * this simplified version tracks reading sessions and estimates pages based on reading time/activity.
 * 
 * Future improvement: Implement full Mushaf page mapping for precise page tracking.
 */
public class QuranReadingTracker {
    
    private static final String TAG = "QuranReadingTracker";
    private static final String PREFS_NAME = "QuranReadingQuestPrefs";
    private static final String KEY_PAGES_READ_TODAY = "pages_read_today";
    private static final String KEY_LAST_DATE = "last_date";
    private static final String KEY_TASK_COMPLETED_TODAY = "task_completed_today";
    
    private final Context context;
    private final SharedPreferences prefs;
    private final QuestRepository questRepository;
    
    public QuranReadingTracker(Context context) {
        this.context = context.getApplicationContext();
        this.prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
        this.questRepository = new QuestRepository(FirebaseFirestore.getInstance());
    }
    
    /**
     * Records that the user has read some pages of the Quran.
     * This should be called when user exits the Quran Reader or after significant reading activity.
     * 
     * @param pagesRead Number of pages read in this session
     */
    public void recordPagesRead(int pagesRead) {
        if (pagesRead <= 0) {
            return;
        }
        
        String today = getTodayDateString();
        int currentPages = getTodayPagesRead();
        int newTotal = currentPages + pagesRead;
        
        prefs.edit()
            .putInt(KEY_PAGES_READ_TODAY, newTotal)
            .putString(KEY_LAST_DATE, today)
            .apply();
        
        Log.d(TAG, "Recorded " + pagesRead + " pages. Total today: " + newTotal);
    }
    
    /**
     * üî• Êñ∞ÊñπÊ≥ïÔºöËÆ∞ÂΩïÂÆûÈôÖÈòÖËØªÁöÑÈ°µÁ†ÅËåÉÂõ¥ÔºàÊõ¥Á≤æÁ°ÆÔºâ
     * 
     * @param startPage ÂºÄÂßãÈ°µÁ†Å
     * @param endPage ÁªìÊùüÈ°µÁ†Å
     */
    public void recordPageRange(int startPage, int endPage) {
        if (startPage <= 0 || endPage <= 0 || endPage < startPage) {
            Log.w(TAG, "Invalid page range: " + startPage + " to " + endPage);
            return;
        }
        
        int pagesRead = endPage - startPage + 1;
        recordPagesRead(pagesRead);
        Log.d(TAG, "Recorded page range: " + startPage + "-" + endPage + " (" + pagesRead + " pages)");
    }
    
    /**
     * üî• Êñ∞ÊñπÊ≥ïÔºöËÆ∞ÂΩïÂÆûÈôÖÈòÖËØªÁöÑÁªèÊñáÊï∞Èáè
     * 
     * @param versesRead ÈòÖËØªÁöÑÁªèÊñáÊï∞
     */
    public void recordVersesRead(int versesRead) {
        if (versesRead <= 0) {
            return;
        }
        
        // Â∞ÜversesËΩ¨Êç¢‰∏∫Á≠âÊïàpages: 10 verses ‚âà 1 page
        int equivalentPages = Math.max(1, versesRead / 10);
        recordPagesRead(equivalentPages);
        Log.d(TAG, "Recorded " + versesRead + " verses (‚âà" + equivalentPages + " pages)");
    }
    
    /**
     * üî• Êñ∞ÊñπÊ≥ïÔºöËÆ∞ÂΩïJuzÈòÖËØªËøõÂ∫¶ÔºàÁî®‰∫éJUZÁ±ªÂûã‰ªªÂä°Ôºâ
     * 
     * @param juzNo JuzÁºñÂè∑ (1-30)
     * @param pagesInJuz Âú®ËØ•JuzÂÜÖÈòÖËØªÁöÑÈ°µÊï∞
     */
    public void recordJuzProgress(int juzNo, int pagesInJuz) {
        if (juzNo < 1 || juzNo > 30 || pagesInJuz <= 0) {
            Log.w(TAG, "Invalid Juz progress: Juz " + juzNo + ", " + pagesInJuz + " pages");
            return;
        }
        
        recordPagesRead(pagesInJuz);
        Log.d(TAG, "Recorded Juz " + juzNo + " progress: " + pagesInJuz + " pages");
    }
    
    /**
     * Gets the number of pages read today.
     * Automatically resets if it's a new day.
     */
    public int getTodayPagesRead() {
        String today = getTodayDateString();
        String savedDate = prefs.getString(KEY_LAST_DATE, "");
        
        // If it's a new day, reset
        if (!today.equals(savedDate)) {
            resetDailyProgress();
            return 0;
        }
        
        return prefs.getInt(KEY_PAGES_READ_TODAY, 0);
    }
    
    /**
     * Checks if the daily quest target has been reached and marks task as complete if needed.
     * üî• Â∑≤ÂºÉÁî®ÔºöËØ∑‰ΩøÁî® checkAndMarkCompleteAsync() Êù•Ëá™Âä®Ëé∑ÂèñÁî®Êà∑ÈÖçÁΩÆ
     * 
     * @param targetPages The target number of pages (from user's quest config)
     * @deprecated Use {@link #checkAndMarkCompleteAsync()} instead
     */
    @Deprecated
    public void checkAndMarkComplete(int targetPages) {
        int pagesRead = getTodayPagesRead();
        
        if (pagesRead >= targetPages) {
            // Check if already marked complete today
            String today = getTodayDateString();
            boolean alreadyCompleted = prefs.getBoolean(KEY_TASK_COMPLETED_TODAY, false);
            String completedDate = prefs.getString("completed_date", "");
            
            if (alreadyCompleted && today.equals(completedDate)) {
                Log.d(TAG, "Task already completed today");
                return; // Already marked today
            }
            
            // Mark as complete
            markTaskComplete();
            
            // Save completion flag
            prefs.edit()
                .putBoolean(KEY_TASK_COMPLETED_TODAY, true)
                .putString("completed_date", today)
                .apply();
            
            Log.d(TAG, "Daily Quran Reading Quest completed! (" + pagesRead + "/" + targetPages + " pages)");
        }
    }
    
    /**
     * ÂºÇÊ≠•Ê£ÄÊü•Âπ∂Ê†áËÆ∞‰ªªÂä°ÂÆåÊàê - Ëá™Âä®‰ªéFirebaseËé∑ÂèñÁî®Êà∑ÈÖçÁΩÆ
     * Ëøô‰ºöÊ†πÊçÆÁî®Êà∑ÁöÑÂÆûÈôÖÁõÆÊ†áÔºàPages/Verses/JuzÔºâÊù•Âà§Êñ≠ÊòØÂê¶ÂÆåÊàê
     */
    public void checkAndMarkCompleteAsync() {
        new Thread(() -> {
            try {
                // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÁôªÂΩï
                if (FirebaseAuth.getInstance().getCurrentUser() == null) {
                    Log.w(TAG, "User not logged in - cannot check quest completion");
                    return;
                }
                
                // Ëé∑ÂèñÁî®Êà∑ÈÖçÁΩÆ
                com.quran.quranaudio.online.quests.data.UserQuestConfig config = 
                    questRepository.getUserQuestConfigSync();
                
                if (config == null) {
                    Log.w(TAG, "No quest config found - using fallback check");
                    checkAndMarkComplete(10); // ÂõûÈÄÄÂà∞ÈªòËÆ§10È°µ
                    return;
                }
                
                // Ê†πÊçÆÈÖçÁΩÆÁöÑÈòÖËØªÂçï‰ΩçÂà§Êñ≠
                int targetGoal = config.getDailyReadingGoal();
                String unit = config.getReadingGoalUnit();
                int currentProgress = getTodayPagesRead();
                
                // üî• ‰øÆÂ§çÔºöÂ∞ÜÁõÆÊ†áËΩ¨Êç¢‰∏∫pagesËøõË°åÊØîËæÉ
                int targetInPages = convertToPages(targetGoal, unit);
                
                Log.d(TAG, "üìñ Checking completion: " + currentProgress + " pages read / " + 
                      targetGoal + " " + unit + " target (‚âà" + targetInPages + " pages needed)");
                
                // ÂΩìÂâçÂÆûÁé∞‰ΩøÁî®pages‰º∞ÁÆóÔºåÊØîËæÉÊó∂‰πü‰ΩøÁî®pages
                boolean isCompleted = currentProgress >= targetInPages;
                
                if (isCompleted) {
                    Log.d(TAG, "‚úÖ Reading goal achieved! " + currentProgress + " >= " + targetInPages);
                    // Check if already marked complete today
                    String today = getTodayDateString();
                    boolean alreadyCompleted = prefs.getBoolean(KEY_TASK_COMPLETED_TODAY, false);
                    String completedDate = prefs.getString("completed_date", "");
                    
                    if (alreadyCompleted && today.equals(completedDate)) {
                        Log.d(TAG, "Task already completed today");
                        return;
                    }
                    
                    // Mark as complete
                    markTaskComplete();
                    
                    // Save completion flag
                    prefs.edit()
                        .putBoolean(KEY_TASK_COMPLETED_TODAY, true)
                        .putString("completed_date", today)
                        .apply();
                    
                    Log.d(TAG, "‚úÖ Daily Quran Reading Quest completed! (" + 
                          currentProgress + " pages ‚âà " + targetGoal + " " + unit + ")");
                } else {
                    Log.d(TAG, "üìö Keep reading: " + currentProgress + "/" + targetInPages + " pages completed");
                }
            } catch (Exception e) {
                Log.e(TAG, "Failed to check quest completion", e);
            }
        }).start();
    }
    
    /**
     * Marks the Quran Reading task as complete in Firebase.
     */
    private void markTaskComplete() {
        // Check if user is logged in
        if (FirebaseAuth.getInstance().getCurrentUser() == null) {
            Log.w(TAG, "User not logged in - cannot mark task complete");
            return;
        }
        
        // Update task completion in Firebase (Task 1: Quran Reading)
        new Thread(() -> {
            try {
                // üî• ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑTaskId
                questRepository.updateTaskCompletion("task1ReadCompleted", true);
                Log.d(TAG, "Task 1 (Quran Reading) marked as complete in Firebase");
            } catch (Exception e) {
                Log.e(TAG, "Failed to mark task as complete", e);
            }
        }).start();
    }
    
    /**
     * Resets daily progress (called when a new day starts).
     */
    private void resetDailyProgress() {
        String today = getTodayDateString();
        prefs.edit()
            .putInt(KEY_PAGES_READ_TODAY, 0)
            .putString(KEY_LAST_DATE, today)
            .putBoolean(KEY_TASK_COMPLETED_TODAY, false)
            .apply();
    }
    
    /**
     * Gets today's date as a string (YYYY-MM-DD).
     */
    private String getTodayDateString() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd", Locale.US);
        return sdf.format(new Date());
    }
    
    /**
     * Â∞Ü‰∏çÂêåÈòÖËØªÂçï‰ΩçËΩ¨Êç¢‰∏∫Á≠âÊïàÁöÑpagesÊï∞
     * 
     * ËΩ¨Êç¢ËßÑÂàôÔºàÂü∫‰∫éÂè§ÂÖ∞ÁªèÊ†áÂáÜMushafÔºâÔºö
     * - PAGES: 1:1 Áõ¥Êé•‰ΩøÁî®
     * - VERSES: Á∫¶12 ayahs = 1 pageÔºàÁ≤óÁï•‰º∞ÁÆóÔºâ
     * - JUZ: 1 juz = 20 pages
     * 
     * @param goal ÁõÆÊ†áÂÄº
     * @param unit Âçï‰ΩçÔºàPAGES/VERSES/JUZÔºâ
     * @return Á≠âÊïàÁöÑpagesÊï∞
     */
    private int convertToPages(int goal, String unit) {
        if (unit == null || unit.isEmpty()) {
            return goal; // ÈªòËÆ§ËßÜ‰∏∫pages
        }
        
        switch (unit.toUpperCase()) {
            case "VERSES":
                // Á≤óÁï•‰º∞ÁÆóÔºö12 verses ‚âà 1 page
                // ‰∏∫‰∫ÜËÆ©Â∞èÁõÆÊ†áÊõ¥ÂÆπÊòìÂÆåÊàêÔºå‰ΩøÁî®10 verses = 1 page
                return Math.max(1, goal / 10);
                
            case "JUZ":
                // 1 Juz' = 20 pages
                return goal * 20;
                
            case "PAGES":
            default:
                return goal;
        }
    }
}




